---
- name: Do base configuration
  include_role:
    name: "ten7.flightdeck_base"
- name: Install needed software
  apk:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - "apache2"
    - "libcap"
    - "zlib"
    - "apache2"
    - "apache2-proxy"
    - "php81-apache2"
    - "php81"
    - "git"
    - "go-task"
    - "patch"
    - "curl"
    - "php81-bcmath"
    - "php81-ctype"
    - "php81-curl"
    - "php81-dom"
    - "php81-fileinfo"
    - "php81-gd"
    - "php81-iconv"
    - "php81-intl"
    - "php81-json"
    - "php81-ldap"
    - "php81-mbstring"
    - "php81-pecl-memcached"
    - "php81-mysqli"
    - "php81-mysqlnd"
    - "php81-opcache"
    - "php81-openssl"
    - "php81-pecl-apcu"
    - "php81-pecl-imagick"
    - "php81-phar"
    - "php81-sqlite3"
    - "php81-odbc"
    - "php81-pdo_odbc"
    - "php81-pdo"
    - "php81-pdo_mysql"
    - "php81-pdo_sqlite"
    - "php81-phar"
    - "php81-pecl-redis"
    - "php81-soap"
    - "php81-session"
    - "php81-simplexml"
    - "php81-sodium"
    - "php81-tokenizer"
    - "php81-xdebug"
    - "php81-exif"
    - "php81-xml"
    - "php81-xmlreader"
    - "php81-xmlwriter"
    - "php81-zip"
    - "php81-zlib"
    - "py3-passlib"
    - "py3-mysqlclient"
    - "py3-jmespath"
    - "composer"
    - "mariadb-client"
    - "rsync"
    - "openssh-client"
    - "nodejs"
    - "npm"
    - "libsass"
    - "nano"
  notify:
    - clear caches
- name: Add global php symlink
  file:
    src: "/usr/bin/php81"
    dest: "/usr/local/bin/php"
    state: link
    force: yes
    follow: no
- name: Force Composer to be ran with PHP 8.1
  lineinfile:
    path: "/usr/bin/composer"
    regexp: '^/usr/bin/php8'
    line: '/usr/bin/php81 /usr/bin/composer.phar $@'
- name: Ensure key directories are owned by apache
  file:
    path: "{{ item }}"
    state: directory
    owner: "apache"
    group: "apache"
    mode: "u=rwx,g=rwx,o=r"
    recurse: yes
  loop:
    - "/etc/apache2"
    - "/etc/ssl/apache2"
    - "/etc/apache2/sites.d"
    - "/etc/php81"
    - "/etc/wpcli"
    - "/run/apache2"
    - "/var/log/apache2"
    - "/var/www"
    - "/var/www/.npm-global"
    - "/srv/html"
- name: Add global symlinks
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    force: yes
    follow: no
  loop:
    - src: "/usr/bin/go-task"
      dest: "/usr/local/bin/task"
- name: Set node global packages to install as user-local
  shell: >
    npm config set prefix '/var/www/.npm-global'
  become: yes
  become_user: "apache"
  become_method: "su"
- name: Install theme utilities
  shell: >
    npm install -g sass gulp
  become: yes
  become_user: "apache"
  become_method: "su"
- name: Template default index.html
  template:
    src: "templates/index.html"
    dest: "/srv/html/index.html"
    owner: "apache"
    group: "apache"
    mode: "u=rw,g=r,o=r"
